# [Infrastructure Analysis](http://www.pentest-standard.org/index.php/Post_Exploitation#Infrastructure_Analysis)
### [Network Configuration](http://www.pentest-standard.org/index.php/Post_Exploitation#Network_Configuration)
##### [Interfaces](http://www.pentest-standard.org/index.php/Post_Exploitation#Interfaces)
Identify network interfaces and subnets on the exploited target.
* [From Meterpreter Session](../../Tools/Metasploit/README.md#Network-Interfaces)
* [From Linux Shell](../../Tools/Shells/Linux/README.md#List-All-Interfaces)
* [From Windows CMD](../../Tools/Shells/Windows/CMD/README.md#List-All-Interfaces)
##### Routing
##### DNS Servers
##### Cached DNS Entries
##### Proxy Servers
##### ARP Entries

### Network Services
##### Listening Services
##### VPN Connections
##### Directory Services
##### [Neighbors](http://www.pentest-standard.org/index.php/Post_Exploitation#Neighbors)
Identify other hosts on all subnets connected to the exploited target.
* [From Meterpreter Session](../../Tools/Metasploit/README.md#Host-Discovery)

# Route, Portfwd, and PortProxy
* Route and Autoroute
  * It is necessary to have an established session.
  * Add complete network addresses indicating their CIDR notation.
  * Route tables are only added at the functional level of the Metasploit Framework.
  * Within Metasploit all modules can be used directly towards aggregated networks.
  * With the post Autorute module you can automatically discover and add network routes from a previously established session.
* portfwd
  * It is necessary to have an established session.
  * They cannot add complete network addresses, only port forwarding rules are created towards a specific IP/Port.
  * Other tools outside of Metasploit can be used locally on the Kali machine itself Local IP/Port will be listening.
  * Within Metasploit modules can be used towards the IP/Port of the created rule, the IP/Port will be interpreted locally from the Kali machine itself.
* PortProxy (Windows) - similar to portfwd, but uses the netsh command.
##### [Pivoting with Metasploit: route, portfwd and portproxy](https://www.zonasystem.com/2020/01/pivoting-con-metasploit-route-portfwd-y-portproxy.html)
##### [Portfwd](https://www.offensive-security.com/metasploit-unleashed/Portfwd/)

# Establish Routes Between Subnets
##### [With Metasploit](../../Tools/Metasploit/README.md#Add-Route)

# Inaccessible Hosts through ProxyChains
1) [Start SOCKS Proxy with Metasploit](../../Tools/Metasploit/README.md#Start-SOCKS-Proxy-for-Proxy-Chains)
2) [Nmap Scan through ProxyChains](../../Tools/NetworkDiscovery/Nmap/README.md#Routing-Trough-ProxyChains)
3) Metasploit acts as a SOCKS Proxy Server and receives the Nmap scan, which is ProxyChains.
4) Metasploit, then, forwards the traffic to the Target, based on the route established.

# Forward Ports To Inaccessible Hosts
1) Run [Nmap Scan through ProxyChains](../../Tools/NetworkDiscovery/Nmap/README.md#Trough-ProxyChains).
2) Establish [Port Forwarding](../../Tools/Metasploit/README.md#Port-Forwarding).
   1) Set Remote / Forwarding host to "Inaccessible" Target.
   2) Set Remote / Forwarding port to a port that was open on the Nmap scan.
   3) Set Local / Listening host to localhost.
   4) Set Local / Listening port to a random port on the local host.
3) Perorm operations, such as scans, pointing to localhost and the port specified as Listening. ```bash nmap -sV -p 1234 localhost ```

# Exploit Inaccessible Hosts

# Forward Ports From Inaccessible Hosts (Target 3 -> Target 2 -> Target 1 -> Attack)
1) Establish [Port Forwarding](../../Tools/Metasploit/README.md#Port-Forwarding) on Target 2.
   1) Set Remote / Forwarding host to Target 1.
   2) Set Remote / Forwarding port to listening port on Target 1.
   2) Set Remote / Forwarding port to listening port on the Attack machine.
   3) Set Local / Listening host to Target 2.
   4) Set Remote / Forwarding port to listening port on Target 2.
2) Establish [Port Forwarding](../../Tools/Metasploit/README.md#Port-Forwarding) on Target 1.
   1) Set Remote / Forwarding host to Attack machine.
   2) Set Remote / Forwarding port to listening port on Attack machine.
   3) Set Local / Listening host to Target 1.
   4) Set Remote / Forwarding port to listening port on Target 1.
3) Target 3 will send data to Target 2, over the specified port.
4) Target 2
   1) Target 2 can send it's own data to Target 1.
   2) Target 2 will receive data from Target 3 and forward the data to Target 1.
5) Target 1
   1) Target 1 can send it's own data to Attack machine.
   2) Target 1 will receive data from Target 2 and forward the data to Attack machine.

# Pivoting References
##### [Pivoting attack traffic](https://www.youtube.com/watch?v=Wn59J8PiIl0)
##### [84 post exploitation pivoting autoroute](https://www.youtube.com/watch?v=jjUamstPDWo)
##### [Multi Manage Network Route via Meterpreter Session - Metasploit](https://www.infosecmatter.com/metasploit-module-library/?mm=post/multi/manage/autoroute)
##### [Webinar - Deep dive in double network Pivoting with Metasploit and ProxyChains](https://www.youtube.com/watch?v=J-F_3PMbNGo)